<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">reactive-web</a> &gt; <a href="index.source.html" class="el_package">co.com.bancolombia.api.user</a> &gt; <span class="el_source">UserHandler.java</span></div><h1>UserHandler.java</h1><pre class="source lang-java linenums">package co.com.bancolombia.api.user;

import co.com.bancolombia.api.dto.ErrorResponseDTO;
import co.com.bancolombia.api.user.dto.UserRequestDTO;
import co.com.bancolombia.api.user.mapper.UserDTOMapper;
import co.com.bancolombia.model.exception.BusinessException;
import co.com.bancolombia.model.exception.InvalidDataException;
import co.com.bancolombia.model.exception.UserExistsException;
import co.com.bancolombia.usecase.user.interfaces.IUserUseCase;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.Schema;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.DependsOn;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Component;
import org.springframework.web.reactive.function.server.ServerRequest;
import org.springframework.web.reactive.function.server.ServerResponse;
import reactor.core.publisher.Mono;

import java.time.Duration;

<span class="fc" id="L30">@Slf4j</span>
@Component
@RequiredArgsConstructor
@Tag(name = &quot;User Management&quot;, description = &quot;Operations related to user management&quot;)
public class UserHandler {

    private final IUserUseCase userUseCase;
    private final PasswordEncoder passwordEncoder;
<span class="fc" id="L38">    private static final Duration REQUEST_TIMEOUT = Duration.ofSeconds(30);</span>

    @Operation(summary = &quot;Create a new user&quot;, description = &quot;Creates a new user in the system&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;201&quot;, description = &quot;User created successfully&quot;,
                    content = @Content(schema = @Schema(implementation = co.com.bancolombia.api.user.dto.UserResponseDTO.class))),
            @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid input data&quot;,
                    content = @Content(schema = @Schema(implementation = ErrorResponseDTO.class))),
            @ApiResponse(responseCode = &quot;409&quot;, description = &quot;User already exists&quot;,
                    content = @Content(schema = @Schema(implementation = ErrorResponseDTO.class))),
            @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Internal server error&quot;,
                    content = @Content(schema = @Schema(implementation = ErrorResponseDTO.class)))
    })
    public Mono&lt;ServerResponse&gt; saveUser(ServerRequest request) {
<span class="fc" id="L52">        log.info(&quot;Processing user registration request from IP: {}&quot;,</span>
<span class="pc" id="L53">                request.remoteAddress().map(addr -&gt; addr.getHostString()).orElse(&quot;unknown&quot;));</span>

<span class="fc" id="L55">        return request.bodyToMono(UserRequestDTO.class)</span>
<span class="fc" id="L56">                .timeout(REQUEST_TIMEOUT)</span>
<span class="fc" id="L57">                .doOnNext(this::logUserCreationRequest)</span>
<span class="fc" id="L58">                .doOnNext(this::validateRequestData)</span>
<span class="fc" id="L59">                .map(this::encryptPassword)</span>
<span class="fc" id="L60">                .map(UserDTOMapper::toDomain)</span>
<span class="fc" id="L61">                .flatMap(userUseCase::saveUser)</span>
<span class="fc" id="L62">                .map(UserDTOMapper::toResponse)</span>
<span class="fc" id="L63">                .flatMap(response -&gt; ServerResponse.status(HttpStatus.CREATED)</span>
<span class="fc" id="L64">                        .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L65">                        .bodyValue(response))</span>
<span class="fc" id="L66">                .doOnSuccess(response -&gt; log.info(&quot;User registered successfully&quot;))</span>
<span class="fc" id="L67">                .doOnError(throwable -&gt; log.error(&quot;Error processing user registration: {}&quot;,</span>
<span class="fc" id="L68">                        throwable.getMessage(), throwable));</span>
    }

    public Mono&lt;ServerResponse&gt; getUserById(ServerRequest request) {
<span class="nc" id="L72">        String userId = request.pathVariable(&quot;id&quot;);</span>
<span class="nc" id="L73">        log.info(&quot;Fetching user with ID: {}&quot;, userId);</span>

<span class="nc" id="L75">        return userUseCase.getUserById(userId)</span>
<span class="nc" id="L76">                .map(UserDTOMapper::toResponse)</span>
<span class="nc" id="L77">                .flatMap(response -&gt; ServerResponse.ok()</span>
<span class="nc" id="L78">                        .contentType(MediaType.APPLICATION_JSON)</span>
<span class="nc" id="L79">                        .bodyValue(response))</span>
<span class="nc" id="L80">                .doOnSuccess(response -&gt; log.info(&quot;User retrieved successfully: {}&quot;, userId))</span>
<span class="nc" id="L81">                .doOnError(throwable -&gt; log.error(&quot;Error retrieving user {}: {}&quot;,</span>
<span class="nc" id="L82">                        userId, throwable.getMessage()));</span>
    }

    public Mono&lt;ServerResponse&gt; getUserByEmail(ServerRequest request) {
<span class="nc" id="L86">        String email = request.pathVariable(&quot;email&quot;);</span>
<span class="nc" id="L87">        log.info(&quot;Fetching user with email: {}&quot;, email);</span>

<span class="nc" id="L89">        return userUseCase.getUserByEmail(email)</span>
<span class="nc" id="L90">                .map(UserDTOMapper::toResponse)</span>
<span class="nc" id="L91">                .flatMap(response -&gt; ServerResponse.ok()</span>
<span class="nc" id="L92">                        .contentType(MediaType.APPLICATION_JSON)</span>
<span class="nc" id="L93">                        .bodyValue(response))</span>
<span class="nc" id="L94">                .doOnSuccess(response -&gt; log.info(&quot;User retrieved successfully by email: {}&quot;, email))</span>
<span class="nc" id="L95">                .doOnError(throwable -&gt; log.error(&quot;Error retrieving user by email {}: {}&quot;,</span>
<span class="nc" id="L96">                        email, throwable.getMessage()));</span>
    }

    public Mono&lt;ServerResponse&gt; getAllUsers(ServerRequest request) {
<span class="nc" id="L100">        log.info(&quot;Fetching all users&quot;);</span>

<span class="nc" id="L102">        return userUseCase.findAll()</span>
<span class="nc" id="L103">                .map(UserDTOMapper::toResponse)</span>
<span class="nc" id="L104">                .collectList()</span>
<span class="nc" id="L105">                .flatMap(users -&gt; ServerResponse.ok()</span>
<span class="nc" id="L106">                        .contentType(MediaType.APPLICATION_JSON)</span>
<span class="nc" id="L107">                        .bodyValue(users))</span>
<span class="nc" id="L108">                .doOnSuccess(response -&gt; log.info(&quot;All users retrieved successfully&quot;))</span>
<span class="nc" id="L109">                .doOnError(throwable -&gt; log.error(&quot;Error retrieving users: {}&quot;,</span>
<span class="nc" id="L110">                        throwable.getMessage()));</span>
    }

    private void logUserCreationRequest(UserRequestDTO dto) {
<span class="fc" id="L114">        log.info(&quot;User registration requested - Email: {}, Name: {} {}&quot;,</span>
<span class="fc" id="L115">                dto.getEmailAddress(), dto.getName(), dto.getLastName());</span>
<span class="fc" id="L116">    }</span>

    private void validateRequestData(UserRequestDTO dto) {
<span class="pc bpc" id="L119" title="2 of 4 branches missed.">        if (dto.getEmailAddress() == null || dto.getEmailAddress().isBlank()) {</span>
<span class="nc" id="L120">            throw new InvalidDataException(&quot;Email address is required&quot;);</span>
        }
<span class="pc bpc" id="L122" title="2 of 4 branches missed.">        if (dto.getName() == null || dto.getName().isBlank()) {</span>
<span class="nc" id="L123">            throw new InvalidDataException(&quot;Name is required&quot;);</span>
        }
<span class="fc" id="L125">    }</span>

    private UserRequestDTO encryptPassword(UserRequestDTO dto) {
<span class="fc" id="L128">        String encryptedPassword = passwordEncoder.encode(dto.getPassword());</span>
<span class="fc" id="L129">        return UserRequestDTO.builder()</span>
<span class="fc" id="L130">                .name(dto.getName())</span>
<span class="fc" id="L131">                .lastName(dto.getLastName())</span>
<span class="fc" id="L132">                .birthDate(dto.getBirthDate())</span>
<span class="fc" id="L133">                .address(dto.getAddress())</span>
<span class="fc" id="L134">                .phone(dto.getPhone())</span>
<span class="fc" id="L135">                .emailAddress(dto.getEmailAddress())</span>
<span class="fc" id="L136">                .baseSalary(dto.getBaseSalary())</span>
<span class="fc" id="L137">                .idRol(dto.getIdRol())</span>
<span class="fc" id="L138">                .password(encryptedPassword)</span>
<span class="fc" id="L139">                .build();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>